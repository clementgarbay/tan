/*! TAN v0.0.1 | Clément GARBAY | 22/11/2015 11:19 */ 

var app=angular.module("App",["ngRoute","ngTouch","mobile-angular-ui"]);app.config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"partials/home.html"}).when("/timetables",{templateUrl:"partials/timetables.html",controller:"TimetablesCtrl"}).when("/timetables/:stationCode/:stationName",{templateUrl:"partials/timetables.html",controller:"TimetablesCtrl"}).when("/timetables/:stationCode/:stationName/:numLine/:direction",{templateUrl:"partials/timetables.html",controller:"TimetablesCtrl"}).when("/infos",{templateUrl:"partials/infos.html",controller:"InfosCtrl"}).when("/maps",{templateUrl:"partials/maps.html",controller:"MapsCtrl"}).when("/offline",{templateUrl:"partials/offline.html",controller:"OfflineCtrl"}).otherwise({redirectTo:"/"})}]),app.filter("keylength",function(){return function(a){return angular.isObject(a)?Object.keys(a).length:void 0}}),app.controller("AppCtrl",["$scope","$location","$route","$rootScope","TanFactory",function(a,b,c,d,e){a.onLine=function(){return window.navigator.onLine},a.error=function(a){"undefined"!=typeof navigator&&navigator.notification?navigator.notification.alert(a,function(){},"Erreur",["OK"]):alert(a)},a.loading=!1,a.startLoading=function(){a.loading=!0},a.stopLoading=function(){a.loading=!1},a.path=function(){return b.path().split("/")[1]},a.refresh=function(){c.reload()},a.openExternal=function(a){"undefined"!=typeof navigator&&navigator.app?navigator.app.loadUrl(a,{openExternal:!0}):window.open(a,"_blank")},d.$on("$routeChangeStart",function(b){a.stopLoading(),e.cancel()}),a.offline_getId=function(a){return a.ligne.numLigne+a.stationCode},a.offline_save=function(b){var c=JSON.parse(localStorage.getItem("stations"));null===c&&(c={}),c[a.offline_getId(b)]=b,localStorage.setItem("stations",JSON.stringify(c))},a.offline_isSaved=function(b){var c=JSON.parse(localStorage.getItem("stations"))||{};return void 0!==c[a.offline_getId(b)]},a.offline_remove=function(b){var c=JSON.parse(localStorage.getItem("stations"));a.offline_isSaved(b)&&delete c[a.offline_getId(b)],localStorage.setItem("stations",JSON.stringify(c))},a.offline_clear=function(){if(angular.element(document.querySelector(".content")).hasClass("ios")){var b=function(){1==button&&(localStorage.removeItem("stations"),a.refresh())};navigator.notification.confirm("Êtes-vous sûr de vouloir supprimer toutes les grilles horaires enregistrées ?",b,"Confirmer la suppression",["Oui","Annuler"])}else confirm("Êtes-vous sûr de vouloir supprimer toutes les grilles horaires enregistrées ?")&&(localStorage.removeItem("stations"),a.refresh())}}]),app.controller("InfosCtrl",["$scope","$log","TanFactory",function(a,b,c){a.startLoading(),a.onLine()?c.getInfoTrafic().then(function(b){a.infos=b,localStorage.setItem("infoTrafic",JSON.stringify(a.infos)),a.stopLoading()},function(b){a.error(b)}):(a.infos=JSON.parse(localStorage.getItem("infoTrafic")),a.stopLoading())}]),app.controller("MapsCtrl",["$scope",function(a){a.openMap=function(b){if(angular.element(document.querySelector(".content")).hasClass("ios")){var c=window.location.href.replace("index.html#/maps","data/"+b+".pdf");PDFReader.open(c,{enableThumbs:!1,bookmarks:!1},function(){},function(b){a.error("Erreur lors de l'ouverture du plan")})}else window.open("data/"+b+".pdf","_blank","location=yes")}}]),app.controller("OfflineCtrl",["$scope",function(a){a.savedStations=JSON.parse(localStorage.getItem("stations"))}]),app.controller("TimetablesCtrl",["$scope","$log","$route","$routeParams","$location","$timeout","TanFactory",function(a,b,c,d,e,f,g){if(a.params={},a.params.stationCode=d.stationCode,a.params.stationName=d.stationName,a.params.numLine=d.numLine,a.params.direction=d.direction,void 0===a.params.stationCode&&(a.startLoading(),g.getStations().then(function(b){a.stations=b,a.stopLoading()},function(b){a.error(b)})),void 0!==a.params.stationCode&&void 0===a.params.numLine)a.startLoading(),a.station={},g.getStationWaitingTime(a.params.stationCode).then(function(b){var c={};angular.forEach(b,function(a,b){void 0===c[a.ligne.numLigne]&&(c[a.ligne.numLigne]={},c[a.ligne.numLigne].num=a.ligne.numLigne,c[a.ligne.numLigne].type=a.ligne.typeLigne,c[a.ligne.numLigne].trafficInfo=a.infotrafic,c[a.ligne.numLigne].directions={}),void 0===c[a.ligne.numLigne].directions[a.sens]&&(c[a.ligne.numLigne].directions[a.sens]={},c[a.ligne.numLigne].directions[a.sens].terminus=a.terminus,c[a.ligne.numLigne].directions[a.sens].waitingTimes=[]),-1===c[a.ligne.numLigne].directions[a.sens].waitingTimes.indexOf(a.temps)&&c[a.ligne.numLigne].directions[a.sens].waitingTimes.push(a.temps)}),a.station.data=c,a.stopLoading()},function(b){a.error(b)});else if(void 0!==a.params.stationCode&&void 0!==a.params.numLine&&void 0!==a.params.direction){a.startLoading();var h=JSON.parse(localStorage.getItem("stations"))||{};void 0!==h[a.params.numLine+a.params.stationCode]?(a.station=h[a.params.numLine+a.params.stationCode],a.stopLoading()):g.getStationTimeTables(a.params.stationCode,a.params.numLine,a.params.direction).then(function(b){a.station=b,a.station.stationCode=a.params.stationCode,a.station.direction=a.params.direction,a.station.directionName=a.station.ligne["directionSens"+a.params.direction],f(function(){angular.forEach(a.station.prochainsHoraires,function(a,b){angular.element(document.querySelector("#tr"+a.heure)).addClass("active"),angular.element(document.querySelector("#td"+a.heure+a.passages[0])).addClass("active")})},200),a.stopLoading()},function(b){a.error(b)})}a.searchByLocalization=function(){a.startLoading();var b=function(b){g.getStationsByPosition(b).then(function(b){a.stations=b,a.stopLoading()},function(b){a.error(b)})},c=function(b){a.error("Erreur "+b.code+"\n"+b.message+"\n"),a.stopLoading()};navigator.geolocation.getCurrentPosition(b,c)},a.previous=function(){a.params.numLine?e.path("/timetables/"+a.params.stationCode+"/"+a.params.stationName):e.path("/timetables")}}]),app.directive("touchable",["$swipe",function(a){return{restrict:"EA",link:function(b,c,d,e){var f,g;a.bind(c,{start:function(a){f=a.x,g=""!==c.css("margin-left")?parseInt(c.css("margin-left")):0},move:function(a){var b=a.x-f,d=g+b;0>d?c.css("margin-left",d+"px"):c.css("margin-left","0px")},end:function(a){},cancel:function(a){}})}}}]),app.factory("TanFactory",["$http","$q",function(a,b){var c={deferred:null,stations:null,waitingTime:null,getStations:function(){return c.deferred=b.defer(),null!==c.stations?c.deferred.resolve(c.stations):a.get("https://open.tan.fr/ewp/arrets.json").success(function(a,b){c.deferred.resolve(a)}).error(function(a,b){console.error(a),c.deferred.reject("Erreur "+b+". \nImpossible de récupérer les informations concernant les arrêts.")}),c.deferred.promise},getStationsByPosition:function(d){c.deferred=b.defer();var e=null!==d?d.coords.latitude+"/"+d.coords.longitude:"";return a.get("https://open.tan.fr/ewp/arrets.json/"+e.replace(/\./g,",")).success(function(a,b){c.deferred.resolve(a)}).error(function(a,b){console.error(a),c.deferred.reject("Erreur "+b+". \nImpossible de récupérer les informations concernant les arrêts à proximité.")}),c.deferred.promise},getStationWaitingTime:function(d){return c.deferred=b.defer(),a.get("https://open.tan.fr/ewp/tempsattente.json/"+d).success(function(a,b){c.waitingTime={},c.waitingTime.stationCode=d,c.waitingTime.data=a,c.deferred.resolve(a)}).error(function(a,b){console.error(a),c.deferred.reject("Erreur "+b+". \nImpossible de récupérer les temps d'attente concernant l'arrêt demandé.")}),c.deferred.promise},getStationTimeTables:function(d,e,f){return c.deferred=b.defer(),a.get("https://open.tan.fr/ewp/horairesarret.json/"+d+"/"+e+"/"+f).success(function(a,b){c.deferred.resolve(a)}).error(function(a,b){console.error(a),c.deferred.reject("Erreur "+b+". \nImpossible de récupérer les horaires concernant la ligne et l'arrêt demandé.")}),c.deferred.promise},getInfoTrafic:function(){c.deferred=b.defer();var d="39W9VSNCSASEOGV";return a.get("http://data.nantes.fr/api/getInfoTraficTANTempsReel/1.0/"+d+"/?output=json").success(function(a,b){c.deferred.resolve(a)}).error(function(a,b){console.error(a),c.deferred.reject("Erreur "+b+". \nImpossible de récupérer les infos trafic.")}),c.deferred.promise},cancel:function(){return null!==c.deferred?(c.deferred.resolve(),c.deferred.promise):void 0}};return c}]);